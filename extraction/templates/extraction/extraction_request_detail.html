{% extends 'extraction/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Detalhes da Solicitação{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2>
            Detalhes da Solicitação #{{ object.id }}
            {% if object.status == 'draft' %}
                <span class="badge bg-secondary">Pendente de Envio</span>
            {% elif object.status == 'requested' %}
                <span class="badge bg-primary">Solicitada</span>
            {% elif object.status == 'approved' %}
                <span class="badge bg-success">Aprovada</span>
            {% elif object.status == 'rejected' %}
                <span class="badge bg-danger">Rejeitada</span>
            {% elif object.status == 'in_progress' %}
                <span class="badge bg-info">Em Andamento</span>
            {% elif object.status == 'completed' %}
                <span class="badge bg-dark">Finalizada</span>
            {% elif object.status == 'failed' %}
                <span class="badge bg-danger">Finalizada - Falhou</span>
            {% elif object.status == 'success' %}
                <span class="badge bg-success">Finalizada - Sucesso</span>
            {% endif %}
        </h2>
    </div>
    <div class="col text-end">
        {% if object.status == 'draft' %}
            <a href="{% url 'extraction:send_to_analysis' object.pk %}" 
               class="btn btn-success" 
               onclick="return confirm('Confirma o envio desta solicitação para análise?')">
                <i class="fas fa-paper-plane"></i> Enviar para Análise
            </a>
        {% endif %}
        <a href="{% url 'extraction:request_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar
        </a>
    </div>
</div>

<!-- Dados da Solicitação -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">Informações da Solicitação</h5>
    </div>
    <div class="card-body">
        <form method="post" class="row g-3">
            {% csrf_token %}
            
            <div class="col-md-6">
                {{ form.request_date|as_crispy_field }}
            </div>
            
            <div class="col-md-6">
                {{ form.requested_by|as_crispy_field }}
            </div>

            <div class="col-12">
                {{ form.organization_unit|as_crispy_field }}
            </div>
            
            <div class="col-12">
                {{ form.additional_info|as_crispy_field }}
            </div>

            {% if object.justification %}
            <div class="col-12">
                <div class="mb-3">
                    <label class="form-label"><strong>Justificativa da Decisão:</strong></label>
                    <p class="form-control-static">{{ object.justification }}</p>
                </div>
            </div>
            {% endif %}
            
            <div class="col-12">
                <button type="submit" class="btn btn-primary" {% if object.status != 'draft' %}disabled{% endif %}>
                    <i class="fas fa-save"></i> Atualizar Solicitação
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Procedures -->
<div class="card mb-4">
    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Procedimentos</h5>
        {% if object.status == 'draft' %}
        <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addProcedureModal">
            <i class="fas fa-plus"></i> Adicionar Procedimento
        </button>
        {% endif %}
    </div>
    <div class="card-body">
        {% if procedures %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Ano</th>
                            <th>Número</th>
                            <th>Informações Adicionais</th>
                            {% if object.status == 'draft' %}
                            <th>Ações</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for procedure in procedures %}
                        <tr>
                            <td>{{ procedure.procedure_type }}</td>
                            <td>{{ procedure.year }}</td>
                            <td>{{ procedure.number }}</td>
                            <td>{{ procedure.additional_info|default:"-" }}</td>
                            {% if object.status == 'draft' %}
                            <td>
                                <button type="button" 
                                        class="btn btn-sm btn-info edit-procedure" 
                                        data-id="{{ procedure.id }}"
                                        data-type="{{ procedure.procedure_type.id }}"
                                        data-year="{{ procedure.year }}"
                                        data-number="{{ procedure.number }}"
                                        data-info="{{ procedure.additional_info|default:'' }}"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editProcedureModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" 
                                        class="btn btn-sm btn-danger delete-procedure"
                                        data-id="{{ procedure.id }}"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deleteProcedureModal">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Nenhum procedimento cadastrado.
            </div>
        {% endif %}
    </div>
</div>

<!-- Documents -->
<div class="card mb-4">
    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">Documentos</h5>
        {% if object.status == 'draft' %}
        <button type="button" class="btn btn-light" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
            <i class="fas fa-plus"></i> Adicionar Documento
        </button>
        {% endif %}
    </div>
    <div class="card-body">
        {% if documents %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Ano</th>
                            <th>Número</th>
                            <th>Arquivo</th>
                            <th>Informações Adicionais</th>
                            {% if object.status == 'draft' %}
                            <th>Ações</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for document in documents %}
                        <tr>
                            <td>{{ document.document_type }}</td>
                            <td>{{ document.year }}</td>
                            <td>{{ document.number }}</td>
                            <td>
                                <a href="{{ document.attached_file.url }}" target="_blank" class="btn btn-sm btn-primary">
                                    <i class="fas fa-download"></i> Download
                                </a>
                            </td>
                            <td>{{ document.additional_info|default:"-" }}</td>
                            {% if object.status == 'draft' %}
                            <td>
                                <button type="button" 
                                        class="btn btn-sm btn-info edit-document" 
                                        data-id="{{ document.id }}"
                                        data-type="{{ document.document_type.id }}"
                                        data-year="{{ document.year }}"
                                        data-number="{{ document.number }}"
                                        data-info="{{ document.additional_info|default:'' }}"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#editDocumentModal">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" 
                                        class="btn btn-sm btn-danger delete-document"
                                        data-id="{{ document.id }}"
                                        data-bs-toggle="modal" 
                                        data-bs-target="#deleteDocumentModal">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                            {% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Nenhum documento cadastrado.
            </div>
        {% endif %}
    </div>
</div>

<!-- Modais -->
{% if object.status == 'draft' %}
{% include 'extraction/includes/procedure_modals.html' %}
{% include 'extraction/includes/document_modals.html' %}
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar Select2
    $('.select2').select2({
        theme: 'bootstrap-5',
        width: '100%'
    });

    // Handlers para edição de Procedimento
    $('.edit-procedure').click(function() {
        const id = $(this).data('id');
        const type = $(this).data('type');
        const year = $(this).data('year');
        const number = $(this).data('number');
        const info = $(this).data('info');

        $('#editProcedureModal #procedure_id').val(id);
        $('#editProcedureModal #id_procedure_type').val(type).trigger('change');
        $('#editProcedureModal #id_year').val(year);
        $('#editProcedureModal #id_number').val(number);
        $('#editProcedureModal #id_additional_info').val(info);
    });

    // Handlers para edição de Documento
    $('.edit-document').click(function() {
        const id = $(this).data('id');
        const type = $(this).data('type');
        const year = $(this).data('year');
        const number = $(this).data('number');
        const info = $(this).data('info');

        $('#editDocumentModal #document_id').val(id);
        $('#editDocumentModal #id_document_type').val(type).trigger('change');
        $('#editDocumentModal #id_year').val(year);
        $('#editDocumentModal #id_number').val(number);
        $('#editDocumentModal #id_additional_info').val(info);
    });

    // Handlers para exclusão
    $('.delete-procedure').click(function() {
        const id = $(this).data('id');
        $('#deleteProcedureModal #procedure_id').val(id);
    });

    $('.delete-document').click(function() {
        const id = $(this).data('id');
        $('#deleteDocumentModal #document_id').val(id);
    });
});
</script>
{% endblock %}